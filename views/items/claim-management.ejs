<!-- Add contact form for each claim -->
<div class="claim-actions">
  <button onclick="openContactForm('<%= claim._id %>')" class="btn btn-contact">
    ğŸ“§ Contact Claimant
  </button>
  
  <!-- Contact Form (hidden by default) -->
  <div id="contactForm-<%= claim._id %>" class="contact-form" style="display: none;">
    <form action="/items/<%= item._id %>/claims/<%= claim._id %>/contact" method="POST">
      <div class="form-group">
        <label>Message to <%= claim.claimant.name %>:</label>
        <textarea name="message" required rows="4" 
                  placeholder="Hello <%= claim.claimant.name %>, I'm the owner of the <%= item.name %>. Please provide additional proof such as purchase receipt, serial number, or distinctive features to verify your ownership..."></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Send Message</button>
        <button type="button" onclick="closeContactForm('<%= claim._id %>')" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- Add these buttons for each claim in your claim-management.ejs -->
<% claims.forEach(claim => { %>
  <div class="claim-item">
    <div class="claim-header">
      <h4>Claim by <%= claim.claimant.name %></h4>
      <span class="claim-status <%= claim.status %>"><%= claim.status %></span>
    </div>
    
    <div class="claim-details">
      <p><strong>Message:</strong> <%= claim.claimMessage %></p>
      <p><strong>Submitted:</strong> <%= claim.createdAt.toLocaleDateString() %></p>
      <p><strong>Queue Position:</strong> #<%= claim.queuePosition %></p>
      <p><strong>Contact:</strong> <%= claim.claimant.email %></p>
    </div>

    <% if (claim.status === 'pending') { %>
    <div class="claim-actions">
      <!-- Email Contact Form -->
      <form action="/items/<%= item._id %>/claims/<%= claim._id %>/contact" method="POST" class="contact-form">
        <div class="form-group">
          <label for="message-<%= claim._id %>">Send Message to Claimant:</label>
          <textarea 
            id="message-<%= claim._id %>" 
            name="message" 
            class="form-control" 
            placeholder="Type your message to the claimant..." 
            required
            rows="3"
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">ğŸ“§ Send Message</button>
      </form>

      <!-- Mark as Returned Button -->
      <form action="/items/<%= item._id %>/claims/<%= claim._id %>/return" method="POST" class="return-form">
        <button type="submit" class="btn btn-success btn-sm">âœ… Mark as Returned</button>
      </form>

      <!-- Reject Claim Button -->
      <form action="/items/<%= item._id %>/claims/<%= claim._id %>/reject" method="POST" class="reject-form">
        <input type="hidden" name="rejectionReason" value="Claim rejected by item owner">
        <button type="submit" class="btn btn-danger btn-sm">âŒ Reject Claim</button>
      </form>
    </div>
    <% } %>
  </div>
<% }); %>
// Route for item owner to view claims on their item
router.get('/:id/claims', requireAuth, async (req, res) => {
  try {
    const itemId = req.params.id;
    console.log('ğŸ” Checking claims for item:', itemId);
    
    const item = await Item.findById(itemId);
    
    if (!item) {
      console.log('âŒ Item not found:', itemId);
      return res.status(404).render('error', {
        title: 'Item Not Found',
        message: 'The item you are looking for does not exist.',
        user: req.session.user
      });
    }

    // Check if current user is the item owner
    if (item.reportedBy.toString() !== req.session.user._id.toString()) {
      console.log('âŒ User not authorized. Item owner:', item.reportedBy, 'Current user:', req.session.user._id);
      return res.status(403).render('error', {
        title: 'Access Denied',
        message: 'You can only view claims for your own items.',
        user: req.session.user
      });
    }

    const claims = await Claim.find({ item: itemId })
      .populate('claimant', 'name email universityId')
      .sort({ createdAt: 1 });

    console.log('ğŸ“‹ Found claims for item:', claims.length);
    claims.forEach(claim => {
      console.log('Claim:', {
        id: claim._id,
        claimant: claim.claimant?.name,
        status: claim.status,
        message: claim.claimMessage
      });
    });

    res.render('items/claim-management', {
      title: 'Manage Claims - ' + item.name,
      user: req.session.user,
      item: item,
      claims: claims
    });

  } catch (error) {
    console.error('Claims management error:', error);
    res.status(500).render('error', {
      title: 'Error',
      message: 'Something went wrong while loading claims.',
      user: req.session.user
    });
  }
});